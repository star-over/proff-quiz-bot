import { Context } from "grammy";
import { customKeyboard } from "./keyboard.js";
import { getRandom, objParse, shuffle, truncate } from "./lib/utils.js";
import { postMessagePoll } from "./post-message-poll.js";
import { postMessageProxy } from "./post-message-proxy.js";
import { postPoll } from "./post-poll.js";
import { postSpoiler } from "./post-spoiler.js";
import { TAnswers, TQuiz, TQuizBundle } from "./quizzes/quiz.js";
import { postMessageInline } from "./post-message-inline.js";
import { assert } from "console";
import { allQuizzes } from "./quizzes/allQuizzes.js";
// ⭐️
export const emojiProxies = ["😀", "👍", "🌈", "⭐️", "🔥", "🌶️", "⚽️", "🏆", "🎸", "🚙", "🚀", "💎", "🧲", "🧡", "🟣", "🔷", "🤡", "👽", "🎃", "🙏", "🦋", "🐌", "🐝", "🌼", "⚡️", "💧", "🍺", "🎯", "⌛️", "💰", "🎈", "🅰️"];
export const numberProxies = ["1️⃣", "2️⃣", "3️⃣", "4️⃣", "5️⃣", "6️⃣", "7️⃣", "8️⃣", "9️⃣", "🔟"];
export const positivePhrases = [
  "👍🏻 Отличная работа!",
  "👏🏻 Cуперпрофессионал!",
  "🤖💫 Что творишь, просто космос!",
  "Супер котэ 😻",
  "Верно! 😺 Мур...",
  "Браво! 🚀",
  "Так держать! 🔥",
  "🔥 Ответ верный! 🔥",
  " 🏆 Ты победитель!",
  "🌟 Сияешь как звезда!",
  "💪 Ты такой сильный!",
  "🧠 Твой разум просто потрясающий!",
  "👍 Классно, молодец!",
  "😊 Ты настоящий герой!",
  "🎉 Ура, ты лучший!",
  "💫 Ты просто космос!",
  "🙌 Так держать, ты супер!",
  "👏 Браво, отличная работа!",
  "💥 Взрываешь мозг!",
  "🌈 Ты яркий и сияющий!",
  "🤩 Выглядишь потрясающе!",
  "🎖️ Ты заслужил награду!",
  "🌟 Ты освещаешь своим светом!",
  "🤖 Твои способности вне конкуренции!",
  "🔥 Ты полыхаешь энергией!",
  "🏅 Заслуженная победа!",
  "🌻 Ты как солнечный лучик!",
  "👌 Превосходно, идеально!",
  "💎 Ты драгоценный камень!",
  "🎈 Ты как воздушный шар!",
  "🌠 Ты сверкаешь как звезда!",
  "🎨 Ты настоящий художник!",
  "🎊 Поздравляю, ты лучший!",
  "🏆 Чемпион среди чемпионов!",
  "😍 Ты очаровательный!",
  "🎯 Точно в яблочко!",
  "💥 Ты взрываешь мою голову!",
  "🌳 Ты как крепкое дерево!",
  "🙌 Высший класс, супер!",
  "💫 Ты просто феномен!",
  "🌊 Ты как волна вдохновения!",
  "🎨 Ты рисуешь шедевры!",
  "🎉 Ты заслуживаешь овации!",
  "🌈 Ты радуга в моей жизни!",
  "🌟 Ты сверкаешь, как звезда!",
  "👏 Апплодисменты тебе!",
  "🔥 Ты горишь от энтузиазма!",
  "🌺 Ты цветок, распускающийся в душе!",
  "🎨 Твоё творчество бесценно!",
  "🚀 Ты как ракета к успеху!",
  "💎 Ты драгоценный и неповторимый!",
  "🦋 Ты порхаешь как бабочка!",
  "🌟 Ты сияешь, как звезда!",
  "🎢 Ты на волне успеха!",
  "🏆 Ты победитель во всём!",
  "🌳 Ты крепкое дерево, способное пережить любую бурю!",
  "🌈 Твои таланты как радуга!",
  "🔥 Ты зажигаешь сердца!",
  "💫 Ты освещаешь своим блеском!",
  "🎨 Твои идеи как произведения искусства!",
  "🎊 Ты заслуживаешь фейерверка!",
  "🎯 Точно в цель, отлично!",
  "🌺 Ты расцветаешь как прекрасный цветок!",
  "🌟 Ты сияешь ярче всех!",
  "🎉 Ты достоин аплодисментов!",
  "🌳 Ты как дуб, сильный и могучий!",
  "💫 Ты вспыхиваешь как сверхновая!",
  "🎨 Твоё творение - шедевр!",
  "🌈 Ты радуга в моей жизни!",
  "🌟 Ты звезда, озаряющая всё вокруг!",
  "🎯 Бинго! Ты попал в яблочко!",
  "🌺 Ты расцветаешь как прекрасный цветок!",
  "💫 Ты сияешь как тысяча солнц!",
  "🎨 Твоё творчество поражает воображение!",
  "🎉 Ты достоин громких оваций!",
  "🌳 Ты непоколебимый как гора!",
  "💥 Ты взрываешь все ожидания!",
  "🌟 Ты сверкаешь как драгоценный камень!",
  "🎊 Ты заслуживаешь праздничного салюта!",
  "🌺 Ты цветок, распускающийся в душе!",
  "💫 Ты сияющая комета!",
  "🎨 Твои творения бесценны!",
  "🎯 Точно в цель, ты лучший!",
  "🌳 Ты крепкое дерево, пережившее бури!",
  "💥 Ты заряжаешь энергией всех вокруг!",
  "🌟 Ты звезда, освещающая мой путь!",
  "🎊 Ты заслуживаешь грандиозного праздника!",
  "🌺 Ты прекрасный цветок, расцветающий в моей жизни!",
  "💫 Ты как метеор, озаряющий всё вокруг!",
  "🎨 Твоё творчество вдохновляет!",
  "🎯 Бинго! Ты снова точно в цель!",
  "🌳 Ты как дуб, могучий и непоколебимый!",
  "💥 Ты взрываешь мои представления о возможном!",
  "🌟 Ты сияешь ярче всех звёзд!",
  "🎊 Ты достоин праздничного фейерверка!",
  "🌺 Ты прекрасный цветок, распускающийся в душе!",
  "💫 Ты как комета, в пути к новым высотам!",
  "🎨 Твои творения - произведения искусства!",
  "🎯 Точно в яблочко, ты меткий стрелок!",
  "🌳 Ты как дуб, стойкий перед любыми испытаниями!",
  "💫 Ты как супернова, взрывающая мой разум!",
  "🎨 Твоё воображение рисует чудесные картины!",
  "🎯 Бинго! Ты мастер меткого попадания!",
  "🌳 Ты как могучий дуб, стоящий против любых бурь!",
  "💥 Ты устраиваешь фейерверк достижений!",
  "🌟 Ты сияешь как драгоценный бриллиант!",
  "🎊 Ты заслуживаешь триумфального фестиваля!",
  "🌺 Ты как весенний цветок, распускающийся в душе!",
  "💫 Ты как комета, устремлённая к новым высотам!",
  "🎨 Твои творения достойны музейных стен!",
  "🎯 Прямо в яблочко, ты снайпер среди интеллектуалов!",
  "💥 Ты взрываешь привычные границы возможного!",
  "🌟 Ты сияешь как бриллиант, освещающий путь!",
  "🎊 Ты достоин феерического празднования успехов!",
  "🌺 Ты как нежная роза, расцветающая в душе!",
  "💫 Ты как стремительная комета, несущая перемены!",
  "🎨 Твои творения вдохновляют и завораживают!",
  "🎯 Быстро и точно, ты меткий стрелок среди умов!",
  "🌳 Ты как величественный дуб, способный выстоять!",
  "💥 Ты взрываешь все ожидания, потрясающе!",
  "🌟 Ты сияешь как самая яркая звезда!",
  "🎊 Ты достоин громких оваций и триумфа!",
  "🌺 Ты как нежный цветок, распускающийся в сердце!",
  "💫 Ты как стремительная комета, летящая к успеху!",
  "🎨 Твои творения - это произведения искусства!",
  "🎯 Меткий стрелок, ты просто гений!",
  "🌳 Ты как несокрушимый дуб, стоящий против ветров!",
  "💥 Ты взрываешь мозг своими достижениями!",
  "🌟 Ты сияешь как полярная звезда, освещающая путь!",
  "🎊 Ты достоин самых громких и радостных празднований!",
  "🌺 Ты как нежный цветок, распускающийся в душе!",
  "💫 Ты как стремительная комета, несущая перемены к лучшему!",
  "🎨 Твои творения - настоящие шедевры!",
  "🎯 Попал в яблочко, ты просто снайпер!",
  "🌳 Ты как могучий дуб, способный вынести любые бури!",
  "💥 Ты делаешь настоящий фурор своими достижениями!",
  "🌟 Ты сияешь как путеводная звезда, показывая нам путь!",
  "🎊 Ты достоин грандиозного фейерверка в честь твоих успехов!",
  "🌺 Ты как прекрасный цветок, украшающий этот мир!",
  "💫 Ты как комета, несущая вдохновение и перемены!",
  "🎨 Твоё творчество - это настоящее искусство!",
  "🎯 Бинго! Ты попал точно в цель, невероятно!",
  "🌳 Ты как непоколебимый дуб, способный выстоять в любых испытаниях!",
  "💥 Ты устраиваешь настоящий фейерверк достижений, браво!",
  "🌟 Ты сияешь ярче всех звёзд на небосклоне!",
  "🎊 Ты достоин триумфального празднования своих успехов!",
  "🌺 Ты как прекрасный цветок, распускающийся в душе!",
  "💫 Ты как мчащаяся комета, несущая вдохновение!",
  "🎨 Твои творения - это настоящие произведения искусства!",
  "🎯 Точно в цель, ты меткий стрелок среди интеллектуалов!",
  "🌳 Ты как могучий дуб, стоящий непоколебимо перед любыми преградами!",
  "💥 Ты взрываешь все ожидания, просто ураган талантов!",
  "🌟 Ты сияешь ярче всех, как путеводная звезда!",
  "🎊 Ты достоин самого грандиозного празднования успехов!",
  "🌺 Ты как прекрасный цветок, распускающийся в сердцах!",
  "💫 Ты как комета, осветившая весь мир своим талантом!",
];

export const negativePhrases = [
  "Подумай получше 🤭",
  "🤦🏼‍♂️ Мимо",
  "Не угадал 🙈",
  "Ну..нет 😔",
  "Плоховато, друг 🙄",
  "Ну, зато теперь знаешь, над чем работать 💪",
  "Не расстраивайся, в следующий раз повезет! 🤞",
  "Не беда, главное - старался 👏",
  "В следующий раз точно получится! 😉",
  "Ничего страшного, все будет хорошо 🙌",
  "Ну что ж, бывает, не грусти 🤷‍♂️",
  "Главное - не сдаваться, ты сможешь! 💪",
  "Не переживай, это всего лишь тест 😊",
  "Еще один шаг к успеху 👍",
  "Ошибки - путь к знаниям 🧠",
  "Ну, по крайней мере, попробовал 👏",
  "Следующий раз точно будет лучше 🤞",
  "Ничего страшного, продолжай стараться 💪",
  "Не переживай, ты на правильном пути 😉",
  "Главное - извлечь урок из этого 🤓",
  "Ну, бывает, просто повезет в следующий раз 🍀",
  "Ничего страшного, главное - не сдаваться 👊",
  "Еще один шаг к успеху 🚀",
  "Не расстраивайся, просто попробуй еще раз 😊",
  "Ты большой молодец, что пытался! 👏",
  "Не отчаивайся, в следующий раз получится 🤞",
  "Главное - учиться на ошибках 🧠",
  "Ну, бывает, просто двигайся дальше 🚀",
  "Не переживай, ты все равно молодец 👍",
  "Ничего страшного, в жизни случается 🤷‍♂️",
  "Еще одна ступень к успеху 👊",
  "Не грусти, в следующий раз повезет 🍀",
  "Ты большой умница, что пытался 👏",
  "Ничего страшного, главное - стараться 💪",
  "Не сдавайся, у тебя все получится 😊",
  "Ну, бывает, на следующий раз повезет 🤞",
  "Главное - двигаться вперед 🚀",
  "Ничего страшного, ты большой молодец 👍",
  "Не волнуйся, в следующий раз точно получится 😉",
  "Ты большой умница, что пытался 👏",
  "Ничего страшного, главное - учиться 🧠",
  "Ну, на этот раз не фартануло 🤷‍♂️",
  "Не расстраивайся, ты справишься в следующий раз 💪",
  "Ничего страшного, главное - не сдаваться 👊",
  "Ну, бывает, но ничего страшного 🤷‍♂️",
  "Ты большой молодец, что попробовал 👏",
  "Не переживай, в следующий раз получится 🤞",
  "Ничего страшного, главное - продолжать стараться 💪",
  "Ну, зато теперь знаешь, над чем работать 🤓",
  "Не сдавайся, ты справишься 👊",
  "Ничего страшного, ошибки - это опыт 🧠",
  "Ну, просто не повезло на этот раз 🍀",
  "Ты большой умница, что пытался 👍",
  "Ничего страшного, главное - верь в себя 😊",
  "Ну, бывает, в следующий раз точно выйдет 🤞",
  "Ну ты даешь, ниже некуда 🤦‍♂️",
  "Ярче солнца сегодня не светит! 🙄",
  "Ну что, не твой день, приятель? 😏",
  "Оригинально, ничего не скажешь 🤔",
  "Поздравляю, ты бьешь все рекорды 👏",
  "Ну, это был явно не твой уровень 🙃",
  "Отличная попытка, но мимо 🤷‍♂️",
  "Видимо, в школе прогуливал, да? 😒",
  "Ну, в следующий раз намного лучше! 🙄",
  "Ого, ты просто гений неудачи 😲",
  "Поздравляю, ты - король провалов 👑",
  "Ну, может, тебе просто не повезло? 🤷‍♀️",
  "Похоже, мозги где-то потерял 🤔",
  "Ну, хотя бы похвально, что пытался 😅",
  "Ничего, в следующей жизни точно получится 😉",
  "Ну что, в следующий раз лучше подготовься 😏",
  "Ого, я в восторге от твоих успехов 🙄",
  "Ну, по крайней мере, ты не один такой 😂",
  "Ну, по меркам космонавтов ты просто звезда 🌟",
  "Так держать, ты точно побьешь рекорды 😒",
  "Ну все, ты официально чемпион по провалам 🏆",
  "Ого, да ты просто талант в этом деле 😱",
  "Ну что, вдохновляешься примером Гагарина? 😏",
  "Твои результаты просто зашкаливают 👏",
  "Ну, зато ты самый оригинальный в группе 🤡",
  "Ну, с твоими способностями тебе пора в космос 🚀",
  "Ого, да ты просто звезда в своем деле 🌟",
  "Ну, зато ты всех развеселил своими ответами 😂",
  "Ничего, в следующий раз точно затмишь Эйнштейна 🤓",
  "Ну, зато ты просто бомба в этом деле 💥",
  "Ого, да ты настоящий профи в провалах 👌",
  "Ну что, готов к Нобелевке в номинации `неудача`? 🏆",
  "Ну, зато теперь ты знаешь, чего не делать 😉",
  "Ого, да ты просто феномен в своем роде 😲",
  "Ну, главное - не теряй этого ценного опыта 🤓",
  "Ну, зато ты всех удивил своим результатом 😏",
  "Ого, да ты настоящий король тестов на провал 👑",
  "Ну, по крайней мере, ты пытался, это что-то 😅",
  "Ну, зато ты точно знаешь, над чем работать 💪",
  "Ого, да ты просто талант в этой области 😎",
  "Ну, видимо, тебе просто не хватило удачи 🍀",
  "Ну, зато теперь ты знаешь, что точно не сдашь 😏",
  "Ого, да ты побил все рекорды по неудачам 🏆",
  "Ну, по крайней мере, ты поднял всем настроение 😂",
  "Ну, зато теперь ты знаешь, что нужно подтянуть 👍",
  "Ого, да ты просто кладезь уникальных идей 🤯",
  "Ну, зато теперь ты точно станешь экспертом в этом 🧠",
  "Ну, главное - не расстраивайся, ты ведь пытался 👏",
  "Ого, да ты просто профессионал в этом деле 😎",
  "Ну, зато теперь ты знаешь, что не стоит повторять 🤔",
  "Неудача - твой конёк 🤦‍♂️",
  "Звезда неудачников 🌟",
  "Везение - не твоё 😒",
  "Провал года поздравляем! 👏",
  "Ну, хоть пытался 👍",
  "Талант потрясающий! 🤯",
  "Следующий раз взлетишь! 🚀",
  "Все тебе мимо 😏",
  "Феноменальный результат 👏",
  "Ты лучший 😂",
  "Гений непонятого 🧠",
  "Надо ещё тренироваться 💪",
  "В следующей жизни 🤞",
  "Ну, хоть старался 👏",
  "Вау, просто вау! 😲",
  "Повезёт в следующий 🍀",
  "Кто бы сомневался 🙄",
  "Это ну просто 😒",
  "Ты настоящий профи! 😎",
  "Ещё раз, ещё 💪",
  "Блестящая попытка! 👏",
  "Это твой профиль 🤷‍♂️",
  "Ничего, бывает 🤷‍♂️",
  "Рекорды бьёшь 👏",
  "Талантище просто 😲",
  "Удачи в следующий 🍀",
  "В космос тебе 🚀",
  "Невероятный успех! 😂",
  "Ты просто шок! 😱",
  "Да ты супер! 👏",
  "Ну так бывает 🤷‍♂️",
  "Ещё постарайся 💪",
  "Гений неудачи 😎",
  "Ошеломительный результат 🤯",
  "Класс, просто класс! 👏",
  "Ну да, ну да 🙄",
  "Очень впечатляет 😏",
  "Потрясающий провал! 😂",
  "Новый рекорд! 🏆",
  "Давай ещё раз 👍",
  "Не расстраивайся 😊",
  "Это твоя стезя 🤷‍♂️",
  "Феерический провал! 😂",
  "Возможность учиться 🧠",
  "Прекрасно, просто! 👏",
  "Снова неудача 😒",
  "Круто, браво! 👏",
  "Лучший из худших 😎",
  "Чемпион по неудачам 🏆",
  "Герой провалов! 🤡",
]

export const messageConfig = {
  parse_mode: "HTML",
  disable_notification: true,
} as const;

function getCorrectAnswerIndex(answers: TAnswers): number {
  return answers.findIndex(({ isCorrect }) => isCorrect);
};

function getCorrectAnswerText(answers: TAnswers): string {
  const answerId = getCorrectAnswerIndex(answers);
  const answer = answers.at(answerId);

  return answer?.proxy
    ? `${answer.proxy}. ${answer.answer}`
    : answer.answer;
};

export function getAnswersWithProxies(answers: TAnswers): TAnswers {
  // const randomizedProxy = shuffle(proxies);
  const randomizedProxy = numberProxies;
  return answers.map((answer, i) => ({ ...answer, proxy: randomizedProxy[i] }));
};

export function makePollConfig(answers: TAnswers, reference: string) {
  return {
    type: "quiz",
    explanation_parse_mode: "HTML",
    disable_notification: true,
    correct_option_id: getCorrectAnswerIndex(answers),
    explanation: makeExplanation(answers, reference),
  } as const;
};

export function getAnswers(answers: TAnswers): string[] {
  return answers.map(({ answer }) => answer ?? "");
};

export function getLevelText(level): string {
  return (level?.length > 0) ? `<b>Уровень:</b> ${level}` : "";
}

export function isStyleOne(quiz: TQuiz): boolean {
  return quiz.answers.filter(({ isCorrect }) => isCorrect).length === 1;
}

export function isAnswerSizeGt100(quiz: TQuiz): boolean {
  return quiz.answers.some(({ answer }) => answer.length > 100);
}

export function getMaxAnswerSize(quiz: TQuiz): number {
  return quiz.answers
    .map(({ answer }) => answer.length)
    .sort((a, b) => a - b)
    .at(-1);
}

export function isQuestionGt250(quiz: TQuiz): boolean {
  return (quiz.topic.length + quiz.question.length) > 250;
}

export async function postQuiz(ctx: Context, quiz: TQuiz): Promise<void> {
  if (isStyleOne(quiz) === false) {
    await postSpoiler(ctx, quiz);
  } else if (quiz.answers.length > 10) {
    await postSpoiler(ctx, quiz);
  } else if (isAnswerSizeGt100(quiz)) {
    await postMessageInline(ctx, quiz);
  } else if (isQuestionGt250(quiz)) {
    // await postMessagePoll(ctx, quiz);
    await postMessageInline(ctx, quiz);
  } else {
    // await postPoll(ctx, quiz);
    await postMessageInline(ctx, quiz);
  }
};

export function getQuizById(quizzes: TQuizBundle, questionId: number) {
  return quizzes.find(({ id }) => id === questionId);
};

export function getAnswerById(quiz: TQuiz, answerId: number) {
  return quiz.answers.find(({ id }) => id === answerId);
};

//todo make it get quiz: TQuiz only
export function makeExplanation(answers: TAnswers, reference: string): string {
  // todo: maximaze info in explanation. Optimasing truncate algorithm.
  // const explanationSizeLimit = 200;

  const answerText = truncate(getCorrectAnswerText(answers), 100, false);
  const explanation = [
    // `<b>Номер:</b> ${correct_option_id + 1}`,
    // `<b>Ответ:</b> ${anserText}`,
    `<b>${answerText}</b>`,
    "",
    `${reference}`,
    // `<b>Источник:</b> ${reference}`,
  ].join("\n");
  return truncate(explanation, 170, true);
};

export function makeExplanation2(phrase: string, proxy: string, answers: TAnswers, reference: string): string {
  // todo: maximaze info in explanation. Optimasing truncate algorithm.
  // const explanationSizeLimit = 200;

  const answerText = truncate(getCorrectAnswerText(answers), 100, false);
  const explanation = [
    phrase,
    "",
    `${proxy} ${answerText}`,
    "",
    reference,
    // `<b>Источник:</b> ${reference}`,
  ].join("\n");
  return truncate(explanation, 200, true);
};

export function makeExplanation3({ user, queryData }): string {
  const query = objParse(queryData);
  const quiz = getQuizById(allQuizzes, Number(query.questionId));
  const answer = getAnswerById(quiz, Number(query.answerId));
  const correctAnswerText = getCorrectAnswerText(quiz.answers)

  if (answer.isCorrect) {
    return [
      "✅✅✅✅✅✅",
      "<tg-spoiler>",
      `@${user}`,
      `${getRandom(positivePhrases)}`,
      "</tg-spoiler>",
    ].join("\n");
  };

  return [
    "❌❌❌❌❌❌",
    "<tg-spoiler>",
    `@${user}`,
    `${getRandom(negativePhrases)}`,
    "",
    "<b>Ответ был:</b>",
    `${query.correctProxy} ${correctAnswerText}`,
    "",
    `<b>Источник:</b>`,
    quiz.reference,
    "</tg-spoiler>",
  ].join("\n");
};
